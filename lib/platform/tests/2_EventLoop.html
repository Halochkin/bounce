<div>
  <link-slot>
    <span>
      <outer-host></outer-host>
    </span>
    <h2>hello world</h2>
  </link-slot>
</div>

<script type="module">
  //Basic version

  //rule #2: all events propagate sync. No more async propagation for UI events. Which is good, because you can never
  //         tell if an event is async or sync.
  //rule #3: all adding of event listeners are dynamic.
  //         No more special rule that event listeners on the same target(phase) can be removed, but not added.

  //tip 1:   all event listeners are removed when the event stack is empty.
  //tip 2:   AT_TARGET works 'the old way', as event listeners on the innermost target.
  //         This means the sum of both capture and bubble event listeners run in insertion order, not necessarily capture before bubble.
  //         It is my opinion that it might be better to always run capture before bubble, also at_target, but
  //         the 'old way' is chosen because I guess that this will cause the least disturbances in existing web apps.

  class OuterHost extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML =
`<upper-inner-link-slot>
   <inner-link-slot>
      <inner-host></inner-host>
   </inner-link-slot>
</upper-inner-link-slot>`;
    }
  }

  class InnerHost extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<h1>hello sunshine</h1>';
    }
  }

  class LinkSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<frame-slot><slot></slot></frame-slot>';
    }
  }

  class FrameSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<slot></slot>';
    }
  }

  class InnerLinkSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<inner-frame-slot><slot></slot></inner-frame-slot>';
    }
  }

  class InnerFrameSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<slot></slot>';
    }
  }

  class UpperInnerLinkSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<upper-inner-frame-slot><slot></slot></upper-inner-frame-slot>';
    }
  }

  class UpperInnerFrameSlot extends HTMLElement {
    constructor() {
      super();
      const shadowRoot = this.attachShadow({mode: "open"});
      shadowRoot.innerHTML = '<slot></slot>';
    }
  }

  //todo add a test for stopPropagation
  //todo add a test for stopImmediatePropagation

  //todo add tests for stopPropagation and stopImmediatePropagation before event dispatch.

  //todo add a test for this type of defaultAction event listener
  // defaultActionEventListener(e) {
  //   if (e.defaultPrevented)
  //     return
  //   // if (!this.hasAttribute("additive"))
  //   //   e.preventDefault()
  //   // if (this.getAttribute('additive') === "once")
  //   //   this.removeAttribute("additive")
  //   const composed = false;
  //   const beforeEvent = new Event("before-red", {composed});
  //   this.dispatchEvent(beforeEvent);
  //   if (beforeEvent.defaultPrevented) //state change aborted
  //     return
  //   doLocalOrGlobalStateChange();
  //   const afterEvent = new Event("after-red", {composed});
  //   this.dispatchEvent(afterevent);
  // }

  customElements.define("outer-host", OuterHost);
  customElements.define("inner-host", InnerHost);
  customElements.define("link-slot", LinkSlot);
  customElements.define("frame-slot", FrameSlot);
  customElements.define("inner-link-slot", InnerLinkSlot);
  customElements.define("inner-frame-slot", InnerFrameSlot);
  customElements.define("upper-inner-link-slot", UpperInnerLinkSlot);
  customElements.define("upper-inner-frame-slot", UpperInnerFrameSlot);

  const outerHost = document.querySelector("outer-host");
  const h1 = outerHost.shadowRoot.children[0].children[0].children[0].shadowRoot.children[0];
  const innerMostShadow = h1.shadowRoot;

  function shortTagName(tagName) {
    return tagName.length < 11 ? tagName: (tagName.split('-').map(n => n.substr(0, 2)).join('-'));
  }

  function nodeName(node) {
    if (node === window)
      return 'window        ';
    if (node === document)
      return 'document      ';
    if (node instanceof DocumentFragment)
      return "##" + shortTagName(node.host.tagName);
    return shortTagName(node.tagName) + "  ";
  }

  function getPropagationRoot(node) {
    if (node === window) return window;
    const root = node.getRootNode();
    return root === document ? window : root;
  }

  const result = [];

  function log(e, capture, node) {
    const propagationRoot = getPropagationRoot(node);
    const b = capture ? 'c' : 'b';
    const root = nodeName(propagationRoot);
    const target = nodeName(node);
    const currentTargetCorrect = e.currentTarget === node;
    const targetCorrect = e.path[0] === e.target;
    const rootCorrect = e.currentDocument === propagationRoot;
    const eventPropsCorrect = currentTargetCorrect && targetCorrect && rootCorrect
    const str = [root, b, target, eventPropsCorrect].map(s => (s + '           ').substr(0, 13)).join(' ');
    result.push(str);
    console.log(str);
  }

  import {composedPath} from "../index.js";
  const targets = composedPath(innerMostShadow, window);
  // import {composedPath} from "../BouncedPath.js";
  // const targets = composedPath(h1, window);

  for (let node of targets) {
    node.addEventListener('bob', e => log(e, false, node), false);
    node.addEventListener('bob', e => log(e, true, node), true);
  }
  h1.dispatchEvent(new Event('bob', {composed: true, bubbles: true}));
  const test =
    `window        c            window        true
window        c            document      true
window        c            HT            true
window        c            BO            true
window        c            DI            true
window        c            LI-SL         true
window        c            SP            true
window        b            OU-HO         true
window        c            OU-HO         true
window        b            SP            true
window        b            LI-SL         true
window        b            DI            true
window        b            BO            true
window        b            HT            true
window        b            document      true
window        b            window        true
##OU-HO       c            ##OU-HO       true
##OU-HO       c            UP-IN-LI-SL   true
##OU-HO       c            IN-LI-SL      true
##OU-HO       b            IN-HO         true
##OU-HO       c            IN-HO         true
##OU-HO       b            IN-LI-SL      true
##OU-HO       b            UP-IN-LI-SL   true
##OU-HO       b            ##OU-HO       true
##IN-HO       c            ##IN-HO       true
##IN-HO       b            H1            true
##IN-HO       c            H1            true
##IN-HO       b            ##IN-HO       true
##H1          b            ##H1          true
##H1          c            ##H1          true
##IN-LI-SL    c            ##IN-LI-SL    true
##IN-LI-SL    c            IN-FR-SL      true
##IN-LI-SL    b            SL            true
##IN-LI-SL    c            SL            true
##IN-LI-SL    b            IN-FR-SL      true
##IN-LI-SL    b            ##IN-LI-SL    true
##IN-FR-SL    c            ##IN-FR-SL    true
##IN-FR-SL    b            SL            true
##IN-FR-SL    c            SL            true
##IN-FR-SL    b            ##IN-FR-SL    true
##UP-IN-LI-SL c            ##UP-IN-LI-SL true
##UP-IN-LI-SL c            UP-IN-FR-SL   true
##UP-IN-LI-SL b            SL            true
##UP-IN-LI-SL c            SL            true
##UP-IN-LI-SL b            UP-IN-FR-SL   true
##UP-IN-LI-SL b            ##UP-IN-LI-SL true
##UP-IN-FR-SL c            ##UP-IN-FR-SL true
##UP-IN-FR-SL b            SL            true
##UP-IN-FR-SL c            SL            true
##UP-IN-FR-SL b            ##UP-IN-FR-SL true
##LI-SL       c            ##LI-SL       true
##LI-SL       c            FR-SL         true
##LI-SL       b            SL            true
##LI-SL       c            SL            true
##LI-SL       b            FR-SL         true
##LI-SL       b            ##LI-SL       true
##FR-SL       c            ##FR-SL       true
##FR-SL       b            SL            true
##FR-SL       c            SL            true
##FR-SL       b            ##FR-SL       true`;
  const s = result.map(s => s.trim()).join('\n');
  console.log(s === test);
</script>